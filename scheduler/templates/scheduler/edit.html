<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Edit Business</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body class="h-full font-sans text-gray-800">
    <div class="min-h-full">
        <!-- Navigation Bar -->
        <nav class="bg-gray-800">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <!-- Left Side -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company">
                        </div>
                        <div class="hidden md:block">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <a href="/dashboard" class="rounded-md bg-gray-900 px-3 py-2 text-sm font-medium text-white">Dashboard</a>
                                <a href="/edit" class="rounded-md bg-gray-900 px-3 py-2 text-sm font-medium text-white" aria-current="page">Edit Business</a>
                            </div>
                        </div>
                    </div>
                    <!-- Right Side -->
                    <div class="hidden md:flex items-center">
                        <p class="mr-4 text-white"><strong>ID:</strong> <span id="user-id"></span></p>
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Page Heading -->
        <header class="bg-white shadow">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Edit Business</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <form id="editBusinessForm">
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="business-name" class="block text-sm font-medium mt-4 dark:text-white">Business Name</label>
                            <input type="text" id="businessName" required class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mt-2" />
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessAddress" class="block text-sm font-medium mt-4 dark:text-white">Address:</label>
                            <input type="text" id="businessAddress" required class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mt-2" />
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessEmail" class="block text-sm font-medium mt-4 dark:text-white">Email:</label>
                            <input type="email" id="businessEmail" required class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mt-2" />
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessPhone" class="block text-sm font-medium mt-4 dark:text-white">Phone:</label>
                            <input type="tel" id="businessPhone" required class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mt-2" />
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessService" class="block text-sm font-medium mt-4 dark:text-white">Business type:</label>
                            <input type="text" id="businessService" required class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mt-2" />
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessImage" class="block text-sm font-medium mt-4 dark:text-white">Business Logo Image:</label>
                            <input type="file" id="businessImage" accept="image/*" class="mt-4 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" />
                            <div class="mt-2">
                                <progress id="uploadProgress" value="0" max="100" class="w-full hidden"></progress>
                                <span id="uploadStatus" class="text-sm text-gray-500 hidden"></span>
                            </div>
                        </div>
                        <div class="form-group mb-3 max-w-sm">          
                            <label for="businessBackground" class="block text-sm font-medium mt-4 text-gray-700">Background Image:</label>
                            <input type="file" id="businessBackground" accept="image/*" class="mt-4 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" />
                            <div class="mt-2">
                                <progress id="backgroundUploadProgress" value="0" max="100" class="w-full hidden"></progress>
                                <span id="backgroundUploadStatus" class="text-sm text-gray-500 hidden"></span>
                            </div>
                        </div>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 bg-indigo-600 text-white font-medium rounded-md">Update Business</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, query, where, getDocs, collection, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
            authDomain: "barbershop-77353.firebaseapp.com",
            projectId: "barbershop-77353",
            storageBucket: "barbershop-77353.appspot.com",
            messagingSenderId: "1018170430611",
            appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app); // Initialize Storage

        // Get user ID from localStorage
        const userId = localStorage.getItem('userId');

        // Display user ID
        if (userId) {
            document.getElementById('user-id').innerText = userId;
            fetchBusinessData(userId);
        } else {
            console.error("User ID not found in localStorage.");
        }

        /**
         * Fetches business data for the given userId and populates the edit form.
         * @param {string} userId - The ID of the user.
         */
        async function fetchBusinessData(userId) {
            try {
                // Create a query to find the document where the 'uid' field matches the userId
                const q = query(collection(db, "businesses"), where("uid", "==", userId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Assuming there's only one document per user ID
                    const docSnap = querySnapshot.docs[0];
                    const data = docSnap.data();
                    document.getElementById('businessName').value = data.business_name || '';
                    document.getElementById('businessAddress').value = data.address || '';
                    document.getElementById('businessEmail').value = data.email || '';
                    document.getElementById('businessPhone').value = data.phone || '';
                    document.getElementById('businessService').value = data.service || '';
                } else {
                    console.error(`No business document found for user ID: ${userId}`);
                    alert(`No business document found for user ID: ${userId}. Please ensure you have created a business entry.`);
                }
            } catch (error) {
                console.error('Error fetching business data:', error);
                alert('Error fetching business data. Please check the console for more details.');
            }
        }

        // Handle form submission for updating business
        document.getElementById('editBusinessForm').onsubmit = async (e) => {
            e.preventDefault();

            const businessName = document.getElementById('businessName').value;
            const businessAddress = document.getElementById('businessAddress').value;
            const businessEmail = document.getElementById('businessEmail').value;
            const businessPhone = document.getElementById('businessPhone').value;
            const businessService = document.getElementById('businessService').value;
            const businessImage = document.getElementById('businessImage').files[0];
            const businessBackground = document.getElementById('businessBackground').files[0];

            try {
                const q = query(collection(db, "businesses"), where("uid", "==", userId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const docRef = doc(db, "businesses", docSnap.id);

                    // Update business details
                    await updateDoc(docRef, {
                        business_name: businessName,
                        address: businessAddress,
                        email: businessEmail,
                        phone: businessPhone,
                        service: businessService,
                    });

                    // Upload business image if a new one is selected
                    if (businessImage) {
                        const storageRef = ref(storage, `businessImages/${userId}/${businessImage.name}`);
                        const uploadTask = uploadBytesResumable(storageRef, businessImage);

                        uploadTask.on('state_changed', (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('uploadProgress').value = progress;
                            document.getElementById('uploadProgress').classList.remove('hidden');
                            document.getElementById('uploadStatus').innerText = `${progress.toFixed(0)}% uploaded`;
                            document.getElementById('uploadStatus').classList.remove('hidden');
                        }, (error) => {
                            console.error('Upload error:', error);
                            alert('Error uploading image. Please check the console for more details.');
                        }, async () => {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            await updateDoc(docRef, { image_url: downloadURL });
                            alert('Business updated successfully!');
                            location.reload();
                        });
                    }

                    // Upload background image if a new one is selected
                    if (businessBackground) {
                        const storageRef = ref(storage, `backgrounds/${userId}/${businessBackground.name}`);
                        const uploadTask = uploadBytesResumable(storageRef, businessBackground);

                        uploadTask.on('state_changed', (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('backgroundUploadProgress').value = progress;
                            document.getElementById('backgroundUploadProgress').classList.remove('hidden');
                            document.getElementById('backgroundUploadStatus').innerText = `${progress.toFixed(0)}% uploaded`;
                            document.getElementById('backgroundUploadStatus').classList.remove('hidden');
                        }, (error) => {
                            console.error('Upload error:', error);
                            alert('Error uploading background image. Please check the console for more details.');
                        }, async () => {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            await updateDoc(docRef, { background: downloadURL });
                            alert('Business updated successfully!');
                            location.reload();
                        });
                    } else {
                        alert('Business updated successfully without background image!');
                        location.reload();
                    }
                } else {
                    console.error(`No business document found for user ID: ${userId}`);
                    alert(`No business document found for user ID: ${userId}. Please ensure you have created a business entry.`);
                }
            } catch (error) {
                console.error('Error updating business:', error);
                alert('Error updating business. Please check the console for more details.');
            }
        };

        // Logout functionality
        document.getElementById('logoutButton').onclick = () => {
            localStorage.removeItem('userId'); // Remove user ID from localStorage
            window.location.href = '/login'; // Redirect to login page
        };
    </script>
</body>
</html>
