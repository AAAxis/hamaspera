


{% extends 'scheduler/base.html' %}

{% block content %}
<div class="min-h-full">
    <!-- Page Heading -->
    <header class="bg-white shadow">
        <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Edit Business Info</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <form id="editBusinessForm">
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessName" class="block text-sm font-medium text-gray-700">Business Name</label>
                        <input type="text" id="businessName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                    </div>
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessAddress" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="businessAddress" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                    </div>
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="businessEmail" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                    </div>
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessPhone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="businessPhone" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                    </div>
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessService" class="block text-sm font-medium text-gray-700">Service</label>
                        <input type="text" id="businessService" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                    </div>
                    <div class="form-group mb-3 max-w-sm">
                        <label for="businessImage" class="block text-sm font-medium text-gray-700">Business Logo</label>
                        <input type="file" id="businessImage" accept="image/*" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                        <div class="mt-2">
                            <progress id="uploadProgress" value="0" max="100" class="w-full hidden"></progress>
                            <span id="uploadStatus" class="text-sm text-gray-500 hidden"></span>
                        </div>
                    </div>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 bg-indigo-600 text-white font-medium rounded-md">Update Business</button>
                </form>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, query, where, getDocs, collection, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
        authDomain: "barbershop-77353.firebaseapp.com",
        projectId: "barbershop-77353",
        storageBucket: "barbershop-77353.appspot.com",
        messagingSenderId: "1018170430611",
        appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Get user ID from localStorage
    const userId = localStorage.getItem('userId');

    // Fetch business data and populate the form
    async function fetchBusinessData(userId) {
        try {
            const q = query(collection(db, "businesses"), where("uid", "==", userId));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const docSnap = querySnapshot.docs[0];
                const data = docSnap.data();
                document.getElementById('businessName').value = data.business_name || '';
                document.getElementById('businessAddress').value = data.address || '';
                document.getElementById('businessEmail').value = data.email || '';
                document.getElementById('businessPhone').value = data.phone || '';
                document.getElementById('businessService').value = data.service || '';
            } else {
                console.error(`No business document found for user ID: ${userId}`);
                alert(`No business document found for user ID: ${userId}. Please ensure you have created a business entry.`);
            }
        } catch (error) {
            console.error('Error fetching business data:', error);
            alert('Error fetching business data. Please check the console for more details.');
        }
    }

    // Handle form submission for updating business
    document.getElementById('editBusinessForm').onsubmit = async (e) => {
        e.preventDefault();

        const businessName = document.getElementById('businessName').value;
        const businessAddress = document.getElementById('businessAddress').value;
        const businessEmail = document.getElementById('businessEmail').value;
        const businessPhone = document.getElementById('businessPhone').value;
        const businessService = document.getElementById('businessService').value;
        const businessImage = document.getElementById('businessImage').files[0];

        try {
            const q = query(collection(db, "businesses"), where("uid", "==", userId));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const docSnap = querySnapshot.docs[0];
                const docRef = doc(db, "businesses", docSnap.id);

                // Update business details
                await updateDoc(docRef, {
                    business_name: businessName,
                    address: businessAddress,
                    email: businessEmail,
                    phone: businessPhone,
                    service: businessService,
                });

                // Upload business image if a new one is selected
                if (businessImage) {
                    const storageRef = ref(storage, `businessImages/${userId}/${businessImage.name}`);
                    const uploadTask = uploadBytesResumable(storageRef, businessImage);

                    uploadTask.on('state_changed', (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('uploadProgress').value = progress;
                        document.getElementById('uploadProgress').classList.remove('hidden');
                        document.getElementById('uploadStatus').innerText = `${progress.toFixed(0)}% uploaded`;
                        document.getElementById('uploadStatus').classList.remove('hidden');
                    }, (error) => {
                        console.error('Upload error:', error);
                        alert('Error uploading image. Please check the console for more details.');
                    }, async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        await updateDoc(docRef, { image_url: downloadURL });
                        alert('Business updated successfully!');
                        location.reload();
                    });
                } else {
                    alert('Business updated successfully!');
                    location.reload();
                }
            } else {
                console.error(`No business document found for user ID: ${userId}`);
                alert(`No business document found for user ID: ${userId}. Please ensure you have created a business entry.`);
            }
        } catch (error) {
            console.error('Error updating business:', error);
            alert('Error updating business. Please check the console for more details.');
        }
    };

    // Fetch business data on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (userId) {
            fetchBusinessData(userId);
        } else {
            console.error("User ID not found in localStorage.");
        }
    });
</script>
{% endblock %}