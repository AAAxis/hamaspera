<!DOCTYPE html>
<html lang="en" class="relative min-h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Barbershop Booking</title>
    <!-- Importing Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.5.2/cdn.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            const authLinks = document.getElementById('auth-links');
            if (userId) {
                authLinks.innerHTML = `
                    <a href="{% url 'orders_history' %}" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50">Orders</a>
                    <a href="{% url 'dashboard' %}" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50">Dashboard</a>
                    <a href="#" onclick="logout()" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50">Logout</a>
                `;
            } else {
                authLinks.innerHTML = `
                    <a href="{% url 'about' %}" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50">About</a>
                    <a href="{% url 'login' %}" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50">Login</a>
                `;
            }
        });

        function logout() {
            // Remove userId from local storage
            localStorage.removeItem('userId');
            
            // Redirect to login page
            window.location.href = "/login"; // Change this URL to your actual login page
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-800 relative min-h-full {% if request.path != '/dashboard/' %}bg-cover bg-center bg-no-repeat bg-opacity-10 backdrop-blur-lg{% endif %}">
    <header class="flex items-center justify-between bg-white p-4 shadow-md">
        <!-- Business Info as Logo and Name -->
        <div class="relative">
         
        <!-- Navbar links -->
        <nav class="flex items-center space-x-4">
            <a href="{% url 'orders_history' %}" class="px-3 py-2 text-sm text-gray-800 hover:text-gray-600">Orders</a>
            <a href="{% url 'dashboard' %}" class="px-3 py-2 text-sm text-gray-800 hover:text-gray-600">Dashboard</a>
            <a href="#" onclick="logout()" class="px-3 py-2 text-sm text-gray-800 hover:text-gray-600">Logout</a>
        </nav>
    </header>
  
    <!-- Main Content Section -->
    <main class="container mx-auto px-4 py-6 min-h-screen md:py-12 md:px-8">
   
  
<body class="bg-gray-50">
    <div class="container mx-auto p-4 text-center">
        <h1 class="text-2xl font-bold mb-4">Order Management</h1>

        <!-- Order Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded shadow">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="py-2 px-4 border-b">Phone</th>
                        <th class="py-2 px-4 border-b">Service</th>
                        <th class="py-2 px-4 border-b">Employee</th>
                        <th class="py-2 px-4 border-b">Date & Time</th>
                        <th class="py-2 px-4 border-b">Status</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <!-- Orders will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
       <!-- ========== FOOTER ========== -->
       <footer class="bg-gray-200 text-center py-4 mt-auto">
        <div class="container mx-auto">
            <p class="text-gray-700">Â© 2023 Barbershop Booking System</p>
        </div>
    </footer>
    <!-- ========== END FOOTER ========== -->


    <script type="module">
        // Initialize Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
            authDomain: "barbershop-77353.firebaseapp.com",
            projectId: "barbershop-77353",
            storageBucket: "barbershop-77353.appspot.com",
            messagingSenderId: "1018170430611",
            appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function fetchAllOrders() {
            const uid = localStorage.getItem('userId'); // Retrieve UID from local storage
            const ordersQuery = query(collection(db, 'orders'), where('store', '==', uid)); // Query to fetch orders by userId
            const ordersSnapshot = await getDocs(ordersQuery);
            const orderTableBody = document.getElementById('orderTableBody');

            ordersSnapshot.forEach(doc => {
                const orderData = doc.data();
                const row = createOrderRow(orderData, doc.id);
                orderTableBody.appendChild(row);
            });
        }

        function createOrderRow(orderData, id) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-2 px-4 border-b">${orderData.phone}</td>
                <td class="py-2 px-4 border-b">${orderData.service}</td>
                <td class="py-2 px-4 border-b">${orderData.employee}</td>
                <td class="py-2 px-4 border-b">${formatDate(orderData.datetime)}</td>
                <td class="py-2 px-4 border-b">
                    <select onchange="changeOrderStatus('${id}', this.value)" class="border rounded">
                        <option value="new" ${orderData.status === 'new' ? 'selected' : ''}>New</option>
                        <option value="confirmed" ${orderData.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                        <option value="declined" ${orderData.status === 'declined' ? 'selected' : ''}>Canceled</option>
                    </select>
                </td>
            `;
            return row;
        }

        window.changeOrderStatus = async function(orderId, newStatus) {
            const orderRef = doc(db, 'orders', orderId);

            try {
                await updateDoc(orderRef, { status: newStatus });
                console.log(`Order ${orderId} status updated to ${newStatus}.`);
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        };

        // Function to format date to a human-readable format without seconds
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString(undefined, options).replace(/:\d{2} /, ' '); // Remove seconds
        }

        // Fetch all orders when the page loads
        fetchAllOrders();
    </script>
</body>
</html>
