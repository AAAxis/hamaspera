{% extends 'scheduler/base.html' %}

{% block content %}
<div class="min-h-full">
    <!-- Business Data Section -->
    <div class="mb-4 mt-8">
        <h2 class="text-4xl font-bold text-gray-900">Business Info</h2>
    </div>
    <div class="flex flex-col shadow-md">
        <div class="-m-1.5 overflow-x-auto bg-white rounded-lg">
            <div class="p-1.5 min-w-full inline-block align-middle">
                <div class="overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                        <thead>
                            <tr>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Logo</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Business Name</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Address</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Email</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Phone</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Business Type</th>
                            </tr>
                        </thead>
                        <tbody id="business-table-body" class="divide-y divide-gray-200 dark:divide-neutral-700">
                            <!-- Business items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Workers Data Section -->
    <div class="mb-4 mt-8">
        <h2 class="text-4xl font-bold text-gray-900">Workers Info</h2>
        <a href="/employees" class="mt-4 bg-white hover:bg-green-100 text-black text-sm py-2 px-4 rounded-lg">
            Add Employee
        </a>
    </div>

    <div class="flex flex-col shadow-md">
        <div class="-m-1.5 overflow-x-auto bg-white rounded-lg">
            <div class="p-1.5 min-w-full inline-block align-middle">
                <div class="overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                        <thead>
                            <tr>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Image</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Name</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Phone</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Services</th>
                            </tr>
                        </thead>
                        <tbody id="employees-table-body" class="divide-y divide-gray-200 dark:divide-neutral-700">
                            <!-- Employee items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Services Modal -->
    <div id="servicesModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Attach Services</h2>
            <div id="servicesList" class="space-y-2">
                <!-- Services will be dynamically fetched and added here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button id="saveServicesButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Save
                </button>
                <button id="closeServicesModal" class="ml-2 bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Working Hours Section -->
    <div class="mt-8 flex">
        <div class="w-full">
            <h2 class="text-2xl font-bold text-gray-900">Update Working Hours</h2>
            <ul class="max-w-xs flex flex-col divide-y divide-gray-200 dark:divide-neutral-700 mt-4">
                <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                    Monday
                    <input type="checkbox" id="monday-working" class="ml-auto">
                    <input type="time" id="monday-from" class="ml-2" disabled>
                    <input type="time" id="monday-to" class="ml-2" disabled>
                </li>
                <!-- Repeat for other days -->
            </ul>
            <button id="saveWorkingHours" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Save Working Hours
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
        authDomain: "barbershop-77353.firebaseapp.com",
        projectId: "barbershop-77353",
        storageBucket: "barbershop-77353.appspot.com",
        messagingSenderId: "1018170430611",
        appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
        measurementId: "G-4VS048B47G"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get user info from localStorage
    const userId = localStorage.getItem("userId");
    const userEmail = localStorage.getItem("email") || "User";

    // Set greeting
    const greetingElement = document.getElementById("greeting");
    if (greetingElement) {
        const currentHour = new Date().getHours();
        let greetingText = "Good Evening";
        if (currentHour < 12) greetingText = "Good Morning";
        else if (currentHour < 18) greetingText = "Good Afternoon";
        greetingElement.innerText = `${greetingText}, ${userEmail}!`;
    }

    // Fetch Business Data
    async function fetchBusinessData(userId) {
        try {
            const q = query(collection(db, 'businesses'), where('uid', '==', userId));
            const querySnapshot = await getDocs(q);
            const businessTableBody = document.getElementById('business-table-body');
            businessTableBody.innerHTML = ''; // Clear table

            querySnapshot.forEach((doc) => {
                const business = doc.data();
                const businessRow = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <img src="${business.image_url}" alt="${business.name}" class="h-10 w-10 rounded-full mx-auto">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.business_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.address}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.service}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <a href="/edit" class="text-blue-600 hover:text-blue-900">Edit</a>
                        </td>
                    </tr>
                `;
                businessTableBody.innerHTML += businessRow;
            });
        } catch (error) {
            console.error('Error fetching business data:', error);
        }
    }

    // Load Employees
    async function loadEmployees() {
        try {
            const q = query(collection(db, 'employees'), where('userId', '==', userId));
            const snapshot = await getDocs(q);
            const employeesTable = document.getElementById('employees-table-body');
            employeesTable.innerHTML = ''; // Clear table

            snapshot.forEach(doc => {
                const employee = doc.data();
                const employeeRow = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                            <img src="${employee.image}" alt="${employee.name}" class="h-10 w-10 rounded-full mx-auto">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${employee.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${employee.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${employee.services}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
                            <button class="text-red-600 hover:text-red-900" onclick="deleteEmployee('${doc.id}')">Delete</button>
                        </td>
                    </tr>
                `;
                employeesTable.innerHTML += employeeRow;
            });
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }


    // Load Services
    async function loadServices() {
        try {
            const q = query(collection(db, 'services'), where('userId', '==', userId));
            const snapshot = await getDocs(q);
            const servicesTable = document.getElementById('servicesTable');
            servicesTable.innerHTML = ''; // Clear table

            snapshot.forEach(doc => {
                const service = doc.data();
                const price = typeof service.price === 'number' ? service.price : parseFloat(service.price) || 0;
                const serviceRow = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${service.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <button class="text-red-600 hover:text-red-900" onclick="deleteService('${doc.id}')">Delete</button>
                        </td>
                    </tr>
                `;
                servicesTable.innerHTML += serviceRow;
            });
        } catch (error) {
            console.error('Error loading services:', error);
        }
    }

    // Call loadEmployees and loadServices when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        if (userId) {
            console.log("User ID found:", userId); // Debugging
            fetchBusinessData(userId);
            loadEmployees();
            loadServices();
        } else {
            console.error("User ID not found in localStorage.");
        }
    });

    // Function to handle file input change
    function handleFileInput(event) {
        const file = event.target.files[0]; // Get the selected file
        if (file) {
            uploadImage(file); // Call the upload function
        } else {
            console.error('No file selected');
        }
    }

    // On clicking the background or button, trigger file input
    const uploadButton = document.getElementById('uploadButton');
    const backgroundImageInput = document.getElementById('backgroundImageInput');
    const backgroundImage = document.getElementById('backgroundImage');
    const uploadingStatus = document.getElementById('uploadingStatus');

    if (uploadButton) {
        uploadButton.addEventListener('click', () => {
            backgroundImageInput.click();
        });
    } else {
        console.error('Upload button not found');
    }

    if (backgroundImageInput) {
        backgroundImageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                // Show the uploading status
                uploadingStatus.classList.remove('hidden');

                try {
                    // Upload the file to Firebase Storage
                    const imageUrl = await uploadToFirebase(file);

                    // Set the uploaded image as background
                    backgroundImage.style.backgroundImage = `url('${imageUrl}')`;

                    // Save the image URL to Firestore with matching UID from local storage
                    await saveImageToFirestore(imageUrl);

                } catch (error) {
                    console.error('Error uploading image:', error);
                } finally {
                    // Hide the uploading status after completion
                    uploadingStatus.classList.add('hidden');
                }
            }
        });
    } else {
        console.error('Background image input not found');
    }

    async function saveImageToFirestore(imageUrl) {
        const userId = localStorage.getItem('userId'); // Get the user ID from local storage

        if (!userId) {
            console.error('User ID not found in local storage.');
            return;
        }

        try {
            // Create a reference to the businesses collection
            const businessesRef = collection(db, 'businesses');
            // Create a query to find the document where the uid field matches userId
            const q = query(businessesRef, where('uid', '==', userId));
            
            // Execute the query
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                // If we found a matching document, update the first one (or handle appropriately if multiple)
                const docRef = doc(db, 'businesses', querySnapshot.docs[0].id);
                await updateDoc(docRef, { background: imageUrl });
                console.log('Background image URL saved successfully:', imageUrl);
            } else {
                console.error('No document found for the given UID:', userId);
            }
        } catch (error) {
            console.error('Error saving image URL to Firestore:', error);
        }
    }
</script>
{% endblock %}
