<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Custom Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-size: cover;
            background-position: center;
            color: #333;
        }

        .banner {
            height: 300px;
            background-image: url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logo {
            width: 150px;
            height: 150px;
            border: 5px solid white;
            border-radius: 50%;
            object-fit: cover;
            margin-top: -75px;
            background-color: white;
        }

        .business-item {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
            margin-bottom: 15px;
        }

        .business-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        /* Progress Bar Styles */
        #progressContainer {
            display: none;
            margin-top: 10px;
        }

        #progressBar {
            width: 100%;
            background-color: #ccc;
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
        }

        #progressBarFill {
            height: 100%;
            background-color: #007BFF;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- Banner Section -->
    <div class="banner"></div>

    

    <!-- Barbershop Information -->
    <div class="container mt-4">
        <h1 id="barbershop-name" class="text-center mb-4"></h1>
        <p id="barbershop-address" class="text-center"></p>
        <p id="barbershop-email" class="text-center"></p>
        <p id="barbershop-service" class="text-center"></p>
        <p id="barbershop-description" class="text-center"></p>
        <p id="barbershop-phone" class="text-center"></p>
        <p id="barbershop-working_hours" class="text-center"></p>
        <p id="barbershop-services" class="text-center"></p>
        <p id="barbershop-services_prices" class="text-center"></p>
        <p id="barbershop-services_descriptions" class="text-center"></p>
    </div>

    <!-- Admin Dashboard Header -->
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-center" style="color: #000;">Admin Dashboard</h2>
            
            <div id="greeting" class="text-center">
                <script>
                    // Get current hour
                    const currentHour = new Date().getHours();
                    let greeting;

                    // Determine the appropriate greeting
                    if (currentHour < 12) {
                        greeting = "Good Morning";
                    } else if (currentHour < 18) {
                        greeting = "Good Afternoon";
                    } else {
                        greeting = "Good Evening";
                    }

                    // Get the user's name (assuming it's stored in localStorage)
                    const userEmail = localStorage.getItem('email') || 'User';

                    // Display the greeting
                    document.write(`${greeting}, ${userEmail}!`);
                </script>
            </div>
            <div class="d-flex align-items-center">
                <p class="mb-0 me-3"><strong>ID:</strong> <span id="user-id"></span></p>
                <button id="logoutButton" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Business Data Section -->
        <div id="business-data" class="row">
            <div class="col-md-6">
                <h3 id="business-name"></h3>
                <p id="business-address"></p>
                <p id="business-email"></p>
                <p>Phone</p>
                <p id="business-service"></p>
                <p id="business-image"></p>
                <p id="business-cover_images"></p>
                <p id="business-cover_images_urls"></p>
                <p>Working Hours</p>
                <p>Services</p>
                <p>Services Prices</p>
                <p>Services Descriptions</p>
            </div>
            <!-- Business items will be dynamically inserted here -->
        </div>

        <!-- Modal for Editing Business Info -->
        <div id="editModal" class="modal fade" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Edit Business Info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editBusinessForm">
                            <!-- Business Name -->
                            <div class="mb-3">
                                <label for="businessName" class="form-label">Business Name:</label>
                                <input type="text" class="form-control" id="businessName" required />
                            </div>
                            <!-- Address -->
                            <div class="mb-3">
                                <label for="businessAddress" class="form-label">Address:</label>
                                <input type="text" class="form-control" id="businessAddress" required />
                            </div>
                            <!-- Email -->
                            <div class="mb-3">
                                <label for="businessEmail" class="form-label">Email:</label>
                                <input type="email" class="form-control" id="businessEmail" required />
                            </div>
                            <!-- Phone -->
                            <div class="mb-3">
                                <label for="businessPhone" class="form-label">Phone:</label>
                                <input type="tel" class="form-control" id="businessPhone" required />
                            </div>
                            <!-- Service -->
                            <div class="mb-3">
                                <label for="businessService" class="form-label">Service:</label>
                                <input type="text" class="form-control" id="businessService" required />
                            </div>
                            <!-- Upload Image -->
                            <div class="mb-3">
                                <label for="businessImage" class="form-label">Upload Image:</label>
                                <input type="file" class="form-control" id="businessImage" accept="image/*" />
                            </div>
                            <!-- Cover Images -->
                            <div class="mb-3">
                                <label for="cover_images" class="form-label">Cover Images:</label>
                                <input type="file" class="form-control" id="cover_images" accept="image/*" multiple />
                            </div>
                            <!-- Cover Images URLs -->
                            <div class="mb-3">
                                <label for="cover_images_urls" class="form-label">Cover Images URLs:</label>
                                <input type="text" class="form-control" id="cover_images_urls" placeholder="Enter image URLs separated by commas" />
                            </div>
                            <!-- Working Hours -->
                            <div class="mb-3">
                                <label for="working_hours" class="form-label">Working Hours:</label>
                                <input type="text" class="form-control" id="working_hours" placeholder="e.g., Mon-Fri: 9am - 6pm" required />
                            </div>
                            <!-- Services -->
                            <div class="mb-3">
                                <label for="services" class="form-label">Services:</label>
                                <input type="text" class="form-control" id="services" placeholder="List of services" required />
                            </div>
                            <!-- Optional Fields for Prices and Descriptions -->
                            <div class="mb-3">
                                <label for="services_prices" class="form-label">Services Prices:</label>
                                <input type="text" class="form-control" id="services_prices" placeholder="Enter prices separated by commas" />
                            </div>
                            <div class="mb-3">
                                <label for="services_descriptions" class="form-label">Services Descriptions:</label>
                                <textarea class="form-control" id="services_descriptions" rows="2" placeholder="Enter descriptions separated by commas"></textarea>
                            </div>
                            <!-- Progress Bar -->
                            <div id="progressContainer" class="mb-3">
                                <label class="form-label">Upload Progress:</label>
                                <div id="progressBar">
                                    <div id="progressBarFill"></div>
                                </div>
                            </div>
                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
            authDomain: "barbershop-77353.firebaseapp.com",
            projectId: "barbershop-77353",
            storageBucket: "barbershop-77353.appspot.com",
            messagingSenderId: "1018170430611",
            appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Get userId from localStorage
        const userId = localStorage.getItem('userId');

        if (userId) {
            document.getElementById('user-id').innerText = userId;
            fetchBusinessData(userId);
        } else {
            document.getElementById('user-id').innerText = 'Not logged in';
        }

        /**
         * Fetches business data for the given userId and displays it on the dashboard.
         * @param {string} userId - The ID of the user.
         */
        async function fetchBusinessData(userId) {
            try {
                const businessesRef = collection(db, "businesses");
                const q = query(businessesRef, where("uid", "==", userId));
                const querySnapshot = await getDocs(q);
                
                const businessDataDiv = document.getElementById('business-data');
                businessDataDiv.innerHTML = ''; // Clear existing data
                if (!querySnapshot.empty) {
                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const businessImage = data.image_url || 'https://via.placeholder.com/60';

                        const businessItem = `
                            <div class="col-md-6 business-item">
                                <img src="${businessImage}" alt="${data.business_name}" class="business-image">
                                <div>
                                    <h5 class="mb-1">${data.business_name}</h5>
                                    <p class="mb-1">Address: ${data.address}</p>
                                    <p class="mb-1">Email: ${data.email}</p>
                                    <small>Service: ${data.service}</small>
                                    <p>Phone: ${data.phone}</p> 
                                    <p>Working Hours: ${data.working_hours}</p>
                                    <p>Services: ${data.services}</p>
                                    <p>Services Prices: ${data.services_prices}</p>
                                    <p>Services Descriptions: ${data.services_descriptions}</p>
                                    <br><br>
                                    <button class="btn btn-sm btn-primary" onclick="openEditModal('${docSnap.id}', '${escapeQuotes(data.business_name)}', '${escapeQuotes(data.address)}', '${escapeQuotes(data.email)}', '${escapeQuotes(data.phone)}', '${escapeQuotes(data.service)}', '${escapeQuotes(data.image_url)}')">Edit</button>
                                </div>
                            </div>
                        `;

                        businessDataDiv.innerHTML += businessItem;
                    });
                } else {
                    businessDataDiv.innerHTML = '<p class="text-center text-dark">No business data found.</p>';
                }
            } catch (error) {
                console.error('Error fetching business data:', error);
                document.getElementById('business-data').innerHTML = '<p class="text-center text-danger">Error loading business data.</p>';
            }
        }

        /**
         * Opens the edit modal and populates it with the current business data.
         * @param {string} businessId - The Firestore document ID of the business.
         * @param {string} businessName - The name of the business.
         * @param {string} businessAddress - The address of the business.
         * @param {string} businessEmail - The email of the business.
         * @param {string} businessPhone - The phone number of the business.
         * @param {string} businessService - The service offered by the business.
         * @param {string} imageUrl - The URL of the business image.
         */
        window.openEditModal = function(businessId, businessName, businessAddress, businessEmail, businessPhone, businessService, imageUrl, working_hours, services, services_prices, services_descriptions) {
            // Populate form fields with existing data
            document.getElementById('businessName').value = businessName || '';
            document.getElementById('businessAddress').value = businessAddress || '';
            document.getElementById('businessEmail').value = businessEmail || '';
            document.getElementById('businessPhone').value = businessPhone || '';
            document.getElementById('businessService').value = businessService || '';
            document.getElementById('businessImage').value = ''; // Clear file input
            document.getElementById('cover_images').value = ''; // Clear file input
            document.getElementById('cover_images_urls').value = ''; // Clear URLs input
            document.getElementById('working_hours').value = working_hours || ''; // Clear working hours
            document.getElementById('services').value = services || ''; // Clear services
            document.getElementById('services_prices').value = services_prices || ''; // Clear prices
            document.getElementById('services_descriptions').value = services_descriptions || ''; // Clear descriptions

            // Initialize Bootstrap modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();

            // Handle form submission
            document.getElementById('editBusinessForm').onsubmit = async (e) => {
                e.preventDefault(); // Prevent default form submission

                const updatedBusiness = {
                    business_name: document.getElementById('businessName').value,
                    address: document.getElementById('businessAddress').value,
                    email: document.getElementById('businessEmail').value,
                    phone: document.getElementById('businessPhone').value,
                    service: document.getElementById('businessService').value,
                    cover_images: document.getElementById('cover_images').value,
                    cover_images_urls: document.getElementById('cover_images_urls').value,
                    working_hours: document.getElementById('working_hours').value,
                    services: document.getElementById('services').value,
                    services_prices: document.getElementById('services_prices').value || '',
                    services_descriptions: document.getElementById('services_descriptions').value || '',
                };

                const fileInput = document.getElementById('businessImage');
                const file = fileInput.files[0]; // Get the selected file

                const progressContainer = document.getElementById('progressContainer');
                const progressBarFill = document.getElementById('progressBarFill');
                progressContainer.style.display = 'none'; // Hide progress by default
                progressBarFill.style.width = '0%';

                try {
                    if (file) {
                        const storageRef = ref(storage, 'business_images/' + file.name);
                        const uploadTask = uploadBytesResumable(storageRef, file);

                        // Show progress bar
                        progressContainer.style.display = 'block';

                        // Monitor upload progress
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                progressBarFill.style.width = `${progress}%`; // Update progress bar width
                            },
                            (error) => {
                                console.error('Upload error:', error);
                                alert('Error uploading image.');
                            },
                            async () => {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                updatedBusiness.image_url = downloadURL; // Add image URL to the object

                                // Update Firestore document
                                const businessRef = doc(db, "businesses", businessId);
                                await updateDoc(businessRef, updatedBusiness);

                                // Refresh data
                                fetchBusinessData(userId);

                                // Hide modal
                                editModal.hide();
                            }
                        );
                    } else {
                        updatedBusiness.image_url = imageUrl || ''; // Keep the existing image URL if no new image is uploaded

                        // Update Firestore document
                        const businessRef = doc(db, "businesses", businessId);
                        await updateDoc(businessRef, updatedBusiness);

                        // Refresh data
                        fetchBusinessData(userId);

                        // Hide modal
                        editModal.hide();
                    }
                } catch (error) {
                    console.error('Error updating business info:', error);
                    alert('Error updating business information.');
                }
            };
        };

        /**
         * Escapes single quotes and backslashes in a string to prevent JavaScript injection.
         * @param {string} str - The string to escape.
         * @returns {string} - The escaped string.
         */
        function escapeQuotes(str) {
            if (!str) return '';
            return str.replace(/\\/g, '\\\\').replace(/'/g, '\\\'').replace(/"/g, '\\"');
        }

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('userId'); // Clear user ID from local storage
            window.location.href = '/';
        });
    </script>
</body>
</html>