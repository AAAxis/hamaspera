{% extends 'scheduler/base.html' %}

{% block content %}
<div class="min-h-full">
    <!-- Business Data Section -->
    <div class="mb-4 mt-8">
        <h2 class="text-4xl font-bold text-gray-900">Business Info</h2>
    </div>
     <div class="flex flex-col shadow-md">
        <div class="-m-1.5 overflow-x-auto bg-white rounded-lg">
            <div class="p-1.5 min-w-full inline-block align-middle">
                <div class="overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                        <thead>
                            <tr>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Logo</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Business Name</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Address</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Email</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Phone</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Business Type</th>
                            </tr>
                        </thead>
                        <tbody id="business-table-body" class="divide-y divide-gray-200 dark:divide-neutral-700">
                            <!-- Business items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="flex justify-center">
        <a href="/edit" class="mt-4 bg-green-500 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg">
            Edit Business
        </a>
    </div>

    <!-- Workers Data Section -->
    <div class="mb-4 mt-8">
        <h2 class="text-4xl font-bold text-gray-900">Workers Info</h2>
    </div>

    <div class="flex flex-col shadow-md divide-y divide-gray-200 dark:divide-neutral-700 border-b border-gray-200 dark:border-neutral-700">
        <div class="-m-1.5 overflow-x-auto bg-white rounded-lg">
            <div class="p-1.5 min-w-full inline-block align-middle">
                <div class="overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                        <thead>
                            <tr>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Image</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Name</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Phone</th>
                                <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Services</th>
                            </tr>
                        </thead>
                        <tbody id="employees-table-body" class="divide-y divide-gray-200 dark:divide-neutral-700">
                            <!-- Employee items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="flex justify-center">
        <a href="/employees" class="mt-4 bg-green-500 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg">
            Add Employee
        </a>
    </div>

    <!-- Services Modal -->
    <div id="servicesModal" class="fixed inset-0 flex items-left justify-left z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Attach Services</h2>
            <div id="servicesList" class="space-y-2">
                <!-- Services will be dynamically fetched and added here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button id="saveServicesButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Save
                </button>
                <button id="closeServicesModal" class="ml-2 bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>

   
                <!-- Working Hours Section -->
                <div class="mt-8 flex">
                    <div class="w-full">
                        <h2 class="text-2xl font-bold text-gray-900">Update Working Hours</h2>
                        <ul class="max-w-xs flex flex-col divide-y divide-gray-200 dark:divide-neutral-700 mt-4">
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Monday
                                <input type="checkbox" id="monday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="monday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="monday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Tuesday
                                <input type="checkbox" id="tuesday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="tuesday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="tuesday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Wednesday
                                <input type="checkbox" id="wednesday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="wednesday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="wednesday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Thursday
                                <input type="checkbox" id="thursday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="thursday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="thursday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Friday
                                <input type="checkbox" id="friday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="friday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="friday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Saturday
                                <input type="checkbox" id="saturday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="saturday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="saturday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                            <li class="inline-flex items-center gap-x-2 py-3 text-sm font-medium text-gray-800 dark:text-white">
                                Sunday
                                <input type="checkbox" id="sunday-working" class="ml-auto">
                                <div class="flex gap-x-2">
                                    <input type="time" id="sunday-from" class="py-1 px-2 border rounded" disabled>
                                    <input type="time" id="sunday-to" class="py-1 px-2 border rounded" disabled>
                                </div>
                            </li>
                        </ul>
                        <button id="saveWorkingHours" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save</button>
                    </div>
                </div>

            </div>
        </main>
    </div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { getFirestore, collection, getDocs, query, where, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDdn3sQrXDz9lGzmCsU7sIfazS56K4ScLI",
        authDomain: "barbershop-77353.firebaseapp.com",
        projectId: "barbershop-77353",
        storageBucket: "barbershop-77353.appspot.com",
        messagingSenderId: "1018170430611",
        appId: "1:1018170430611:web:3667f5a317d34e0e2ea966",
        measurementId: "G-4VS048B47G"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get user info from localStorage
    const userId = localStorage.getItem("userId");
    const userEmail = localStorage.getItem("email") || "User";

    // Set greeting
    const greetingElement = document.getElementById("greeting");
    if (greetingElement) {
        const currentHour = new Date().getHours();
        let greetingText = "Good Evening";
        if (currentHour < 12) greetingText = "Good Morning";
        else if (currentHour < 18) greetingText = "Good Afternoon";
        greetingElement.innerText = `${greetingText}, ${userEmail}!`;
    }


  
// Function to fetch services from Firebase Firestore where userId matches uid
async function fetchServices(existingServices) {
    try {
        const servicesRef = collection(db, 'services');
        const q = query(servicesRef, where('userId', '==', userId)); // Filter by userId
        const querySnapshot = await getDocs(q);

        const servicesList = document.getElementById('servicesList');
        servicesList.innerHTML = ''; // Clear existing services

        if (querySnapshot.empty) {
            console.log("No services found for userId:", userId);
            return;
        }

        // Iterate through the documents and create checkboxes with price, image, and document ID
        querySnapshot.forEach((doc) => {
            const serviceData = doc.data();
            const serviceName = serviceData.name;
            const servicePrice = serviceData.price; // Assuming price is a field in the document
            const serviceImage = serviceData.image; // Assuming image URL is a field in the document
            const serviceId = doc.id; // Get document ID

            const label = document.createElement('label');
            label.className = 'flex items-center mb-2'; // Add some spacing between services
            label.innerHTML = `
                <input type="checkbox" value="${serviceId}" class="mr-2" ${existingServices.includes(serviceId) ? 'checked' : ''} />
                <img src="${serviceImage}" alt="${serviceName}" class="w-12 h-12 mr-2 rounded" />
                <span>${serviceName} - $${servicePrice}</span>
            `;
            servicesList.appendChild(label);
        });
    } catch (error) {
        console.error("Error fetching services:", error);
    }
}


    // Fetch Business Data
    async function fetchBusinessData(userId) {
        try {
            const q = query(collection(db, 'businesses'), where('uid', '==', userId));
            const querySnapshot = await getDocs(q);
            const businessTableBody = document.getElementById('business-table-body');
            businessTableBody.innerHTML = ''; // Clear table

            querySnapshot.forEach((doc) => {
                const business = doc.data();
                const businessRow = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <img src="${business.image_url}" alt="${business.name}" class="h-10 w-10 rounded-full mx-auto">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.business_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.address}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">${business.service}</td>
                    </tr>
                `;
                businessTableBody.innerHTML += businessRow;
            });
        } catch (error) {
            console.error('Error fetching business data:', error);
        }
    }


// Function to fetch and display employees
async function fetchEmployees() {
    const userId = localStorage.getItem('userId');
    if (!userId) {
        console.error("User ID not found in localStorage.");
        return;
    }

    try {
        const employeesCollection = collection(db, "employees");
        const q = query(employeesCollection, where("userId", "==", userId)); // Filter by userId
        const employeesSnapshot = await getDocs(q);

        const employeesTableBody = document.getElementById('employees-table-body');
        employeesTableBody.innerHTML = ''; // Clear existing entries

        if (employeesSnapshot.empty) {
            employeesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-black">No employees found.</td></tr>';
        } else {
            employeesSnapshot.forEach((doc) => {
                const employeeData = doc.data();
                const employeeId = doc.id; // Get the document ID

                const employeeRow = `
                    <tr>
                        <td class="px-4 py-2">
                            <img src="${employeeData.image || 'placeholder-image-url'}" alt="Profile Image" class="w-10 h-10 object-cover" />
                        </td>
                        <td class="px-4 py-2">${employeeData.name || 'N/A'}</td>
                        <td class="px-4 py-2">${employeeData.phone || 'N/A'}</td>
                        <td class="px-4 py-2">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded attach-service-button" data-id="${employeeId}">Attach</button>
                        </td>
                    </tr>
                `;
                employeesTableBody.innerHTML += employeeRow; // Add employee row to table body
            });
        }
    } catch (error) {
        console.error('Error fetching employees:', error);
    }
}

// Event listener for Attach Service buttons
document.getElementById('employees-table-body').addEventListener('click', async (event) => {
    if (event.target.classList.contains('attach-service-button')) {
        const employeeId = event.target.getAttribute('data-id');
        console.log("Opening service modal for employee ID:", employeeId); // Debugging

        // Fetch the employee document to get previously attached services
        const employeeRef = doc(db, "employees", employeeId);
        const employeeDoc = await getDoc(employeeRef);
        
        // Get the existing services for the employee
        let existingServices = [];
        if (employeeDoc.exists()) {
            existingServices = employeeDoc.data().services || []; // Assume services is an array
        }

        // Fetch and display services when the modal opens
        await fetchServices(existingServices);
        
        // Open the modal
        document.getElementById('servicesModal').classList.remove('hidden');

        // Save button click handler
        document.getElementById('saveServicesButton').onclick = async () => {
            const selectedServiceIds = Array.from(document.querySelectorAll('#servicesList input[type="checkbox"]:checked')).map(input => input.value);
            console.log("Selected service IDs for employee ID:", employeeId, selectedServiceIds); // Debugging

            // Save the selected services for the employee
            await updateDoc(employeeRef, {
                services: selectedServiceIds // Update employee document with selected service IDs
            });
            alert("Services attached successfully!");
            closeServiceModal(); // Close the modal after saving
        };
    }
});

// Function to close the service modal
function closeServiceModal() {
    document.getElementById('servicesModal').classList.add('hidden');
}


// Optionally, you could call the fetchServices() function here to trigger it on page load or modal open


    


        // Fetch business data on page load
        if (userId) {
            fetchBusinessData(userId);
            fetchEmployees();
        }

        // Enable/disable time inputs based on checkbox
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (event) => {
                const day = event.target.id.split('-')[0];
                document.getElementById(`${day}-from`).disabled = !event.target.checked;
                document.getElementById(`${day}-to`).disabled = !event.target.checked;
            });
        });

        // Close modal functionality (already present in your file)
        document.getElementById('closeServicesModal').onclick = function() {
            document.getElementById('servicesModal').classList.add('hidden');
        };

      


        // Save working hours
        document.getElementById('saveWorkingHours').addEventListener('click', async () => {
            const workingHours = {};
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const day = checkbox.id.split('-')[0];
                workingHours[day] = {
                    working: checkbox.checked,
                    from: document.getElementById(`${day}-from`).value,
                    to: document.getElementById(`${day}-to`).value
                };
            });

            try {
                const userId = localStorage.getItem('userId');
                const workingHoursRef = doc(db, 'working_hours', userId);
                await setDoc(workingHoursRef, { workingHours });
                alert('Working hours updated successfully');
            } catch (error) {
                console.error('Error updating working hours:', error);
                alert('Error updating working hours.');
            }
        });
    </script>
{% endblock %}
